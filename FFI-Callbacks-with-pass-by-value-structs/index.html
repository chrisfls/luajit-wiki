<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-type" content="text/html;charset=utf-8">
  <meta name="MobileOptimized" content="width">
  <meta name="HandheldFriendly" content="true">
  <meta name="viewport" content="width=device-width">
  <link rel=”alternate” type=”application/rss+xml” title=”wiki.luajit.org edit and commit log” href=”http://wiki.luajit.org/feeds/global.xml” />
  <link rel="stylesheet" type="text/css" href="/luajit-wiki/css/gollum.css" media="all">
  <link rel="stylesheet" type="text/css" href="/luajit-wiki/css/editor.css" media="all">
  <link rel="stylesheet" type="text/css" href="/luajit-wiki/css/dialog.css" media="all">
  <link rel="stylesheet" type="text/css" href="/luajit-wiki/css/template.css" media="all">
  <link rel="stylesheet" type="text/css" href="/luajit-wiki/css/print.css" media="print">
  <link rel="stylesheet" type="text/css" href="/luajit-wiki/custom.css" media="all">
  

  <!--[if IE 7]>
  <link rel="stylesheet" type="text/css" href="/luajit-wiki/css/ie7.css" media="all">
  <![endif]-->

  <script>
      var baseUrl = '';
      var uploadDest   = '';
      var pageFullPath = 'FFI Callbacks with pass by value structs';
  </script>
  <script type="text/javascript" src="/luajit-wiki/javascript/jquery-1.7.2.min.js"></script>
  <script type="text/javascript" src="/luajit-wiki/javascript/mousetrap.min.js"></script>
  <script type="text/javascript" src="/luajit-wiki/javascript/gollum.js"></script>
  <script type="text/javascript" src="/luajit-wiki/javascript/gollum.dialog.js"></script>
  <script type="text/javascript" src="/luajit-wiki/javascript/gollum.placeholder.js"></script>
  <script type="text/javascript" src="/luajit-wiki/javascript/editor/gollum.editor.js"></script>

  

  <title>FFI Callbacks with pass by value structs</title>
</head>
<body>

<div id="cust-site">
  <a href="http://luajit.org"><span>Lua<span id="cust-logo">JIT</span></span></a>
</div>
<div id="cust-header">
  <h1>The LuaJIT Wiki</h1>
</div>
<div id="user">
    <p>
      not logged in | <strong><a href="/luajit-wiki/__omnigollum__/login">[Login]</a></strong>
    <p>
</div>

<script>
Mousetrap.bind(['e'], function( e ) {
  e.preventDefault();
  window.location = "/edit" + window.location.pathname;
  return false;
});
</script>
<div id="wiki-wrapper" class="page">
<div id="head">
  <h1>FFI Callbacks with pass by value structs</h1>
  <ul class="actions">
    <li class="minibutton">
      <div id="searchbar">
        <form action="/search" method="get" id="search-form">
        <div id="searchbar-fauxtext">
          <input type="text" name="q" id="search-query" value="Search&hellip;" autocomplete="off">
          <a href="#" id="search-submit" title="Search this wiki">
            <span>Search</span>
          </a>
        </div>
        </form>
      </div>    </li>
    <li class="minibutton"><a href="/luajit-wiki/"
       class="action-home-page">Home</a></li>
    <li class="minibutton"><a href="/luajit-wiki/pages"
      class="action-all-pages">All</a></li>
    <li class="minibutton"><a href="/luajit-wiki/fileview"
    class="action-fileview">Files</a></li>
      <li class="minibutton jaws">
        <a href="#" id="minibutton-new-page">New</a></li>
        <li class="minibutton jaws">
          <a href="#" id="minibutton-rename-page">Rename</a></li>
        <li class="minibutton"><a href="/luajit-wiki/edit/FFI-Callbacks-with-pass-by-value-structs"
           class="action-edit-page">Edit</a></li>
    <li class="minibutton jaws">
    <li class="minibutton"><a href="/luajit-wiki/history/FFI-Callbacks-with-pass-by-value-structs"
       class="action-page-history">History</a></li>
	<li class="minibutton jaws">
    <li class="minibutton"><a href="/luajit-wiki/latest_changes"
       class="action-page-history">Latest Changes</a></li>
  </ul>
</div>
<div id="wiki-content">
<div class="">
  <div id="wiki-body" class="gollum-markdown-content">
    <div class="markdown-body">
      <p>When you have a C callback that uses pass by value semantics for structs, LuaJIT FFI cannot handle this case directly, but it can indirectly.  When a function is called that has pass by value structs, the structs are placed on the stack and the function receives the stack addresses to the structs.  With this in mind, it is possible to redefine the function so that the parameters of function are pointers to the struct, then in the callback dereference the pointers to get the struct values.  Keep in mind that this data is on the stack and will go out of scope at the end of the function.  </p>

<p>In the Clang library, the clang_visitChildren function accepts a callback that is defined as: </p>

<p><code>typedef enum CXChildVisitResult (*CXCursorVisitor)(CXCursor cursor, CXCursor parent, CXClientData client_data);</code></p>

<p>Note that the CXCursor parameters are passed in by value, and not address (CXClientData is a typedef for void*).  If we redefine the function as:</p>

<p><code>typedef enum CXChildVisitResult (*CXCursorVisitor_WithPointers)(CXCursor* cursor, CXCursor* parent, CXClientData client_data);</code></p>

<p>This allows you to write a lua function to be used with luaJIT's FFI that will allow us to receive pointers to those structs.  For example, we want to write a lua function that returns a table with all the children of a given cursor.  One way to do this is to use a function generator that allows us to set an upvalue that will be consistent between runs of the callback.</p>

<pre class="highlight"><code><span class="k">function</span> <span class="nf">createCursorVisitor</span><span class="p">(</span><span class="n">storage</span><span class="p">)</span>
   <span class="kd">local</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">storage</span>

   <span class="k">return</span> <span class="k">function</span><span class="p">(</span><span class="n">cursorPtr</span><span class="p">,</span> <span class="n">parentPtr</span><span class="p">,</span> <span class="n">usr</span><span class="p">)</span>
      <span class="kd">local</span> <span class="n">c</span> <span class="o">=</span> <span class="n">ffi</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="s2">"CXCursor"</span><span class="p">,</span> <span class="n">cursorPtr</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="c1">--create a copy from the passed in pointer</span>
      <span class="kd">local</span> <span class="n">cursor</span> <span class="o">=</span> <span class="n">createCursor</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="c1">--create a lua version</span>
      <span class="nb">table.insert</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="n">cursor</span><span class="p">)</span> <span class="c1">--add to the list children to be returned at the end</span>
      
      <span class="k">return</span> <span class="n">lib</span><span class="p">.</span><span class="n">CXChildVisit_Continue</span>
   <span class="k">end</span>
<span class="k">end</span></code></pre>


<p>This lua function accepts a table and sets it as the upvalue for a returned anonymous function.  This returned function is the function we will use for our callback.  In this function we take the pointer to the child cursor and then create a copy of it and saves it in our upvalue table for later.  We have to have a copy because the value pointed to by cursorPtr will go out of scope when this function returns.</p>

<p>To see how we use this callback we need to create our table to contain the children, then create the callback function with the function creator.  Then we cast the lua function to a callback and call the clang_visitChildren function with our callback.  </p>

<pre class="highlight"><code><span class="k">function</span> <span class="nc">clang_cursor</span><span class="p">.</span><span class="nf">children</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>
   <span class="kd">local</span> <span class="n">cptr</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">cursor</span> 
   <span class="kd">local</span> <span class="n">ret</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1">--create a table to hold all the children</span>
   <span class="kd">local</span> <span class="n">cursorVisitor</span> <span class="o">=</span> <span class="n">createCursorVisitor</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="c1">--generate a function that uses our tables an upvalue</span>
   
   <span class="kd">local</span> <span class="n">cb</span> <span class="o">=</span> <span class="n">ffi</span><span class="p">.</span><span class="n">cast</span><span class="p">(</span><span class="s2">"CXCursorVisitor_WithPointers"</span><span class="p">,</span> <span class="n">cursorVisitor</span><span class="p">)</span> <span class="c1">--this will use our redefined function definition</span>
   <span class="n">lib</span><span class="p">.</span><span class="n">clang_visitChildren</span><span class="p">(</span><span class="n">cptr</span><span class="p">,</span> <span class="n">cb</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
   <span class="n">cb</span><span class="p">:</span><span class="n">free</span><span class="p">()</span> <span class="c1">--release the callback object</span>
   
   <span class="k">return</span> <span class="n">ret</span>
<span class="k">end</span></code></pre>


<p>When the clang_visitChildren returns, our table will contain all the children of the passed in cursor.  We then clean up our callback and return our table of children cursors.</p>

    </div>
  </div>
  </div>

</div>
<div id="footer">
  <p id="last-edit">Last edited by <b>Spar (GitSparTV)</b>, 2020-07-26 16:07:34</p>
    <p>
      <a id="delete-link" href="/luajit-wiki/FFI-Callbacks-with-pass-by-value-structs" data-confirm="Are you sure you want to delete this page?"><span>Delete this Page</span></a>
    </p>
</div>
</div>

<form name="rename" method="POST" action="/rename/FFI-Callbacks-with-pass-by-value-structs">
  <input type="hidden" name="rename"/>
  <input type="hidden" name="message"/>
</form>
<div id="cust-footer">
  <p>Sponsored by <a href="http://www.networkradius.com">Network RADIUS</a></p>
</div>


</body>
</html>
